# 银企直联

## 表结构

qw_approval_affiliation_account表的company_id关联company_account的id。qw_approval_affiliation_account中的affiliation_company对应企微审批中的归属公司也就是付款公司。

```sql
-- auto-generated definition
create table company_account
(
    id           bigint auto_increment
        primary key,
    company_code varchar(50)                        not null comment '公司编码',
    company_name varchar(255)                       not null comment '公司名称',
    organization varchar(255)                       null comment '组织',
    bank         varchar(50)                        null comment '银行',
    bank_account varchar(255)                       null comment '银行账号',
    status       int      default 1                 null comment '状态 1正常 2停用',
    remark       varchar(50)                        null comment '备注',
    create_time  datetime default CURRENT_TIMESTAMP not null,
    update_time  datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP
)
    comment '公司账号' row_format = DYNAMIC;
-- auto-generated definition
create table qw_approval_affiliation_account
(
    id                  bigint auto_increment
        primary key,
    affiliation_company varchar(50)                        null comment '归属公司',
    company_id          varchar(50)                        null comment '公司id',
    company_name        varchar(255)                       null comment '公司名称',
    sp_name             varchar(50)                        null comment '申请模板名称',
    is_default          tinyint                            not null,
    create_time         datetime default CURRENT_TIMESTAMP not null,
    update_time         datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP
)
    comment '企微申请归属账户' row_format = DYNAMIC;

```

![image-20241112104259250](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241112104259250.png)



```sql
-- auto-generated definition
create table qw_payment_approval
(
    id                  bigint auto_increment
        primary key,
    srcbatch_no         varchar(50)                        not null comment '来源业务批次号',
    sp_no               varchar(50)                        not null comment '审批号',
    sub_no              varchar(50)                        null,
    sp_name             varchar(50)                        not null comment '审批模版名称',
    applyer_user_id     varchar(50)                        not null comment '申请人企微id',
    payment_reason      text                               not null comment '付款事由',
    payment_amount      varchar(20)                        not null comment '付款金额',
    cost_affiliation    varchar(50)                        not null comment '费用归属',
    payee_full_name     varchar(50)                        not null comment '收款人',
    bank_account_number varchar(50)                        not null comment '银行账号',
    bank_branch         varchar(50)                        not null comment '开户行支行',
    pay_status          tinyint  default 0                 null comment '支付状态 0:未支付 1:支付中 2:支付成功 3:支付失败',
    pay_receipts_url    varchar(255)                       null comment '支付回单链接',
    pay_receipts_status tinyint  default 1                 null comment '支付回单状态 1:未回单 2:已回单',
    create_time         datetime default CURRENT_TIMESTAMP not null,
    update_time         datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP
)
    comment '企微付款审批';

-- auto-generated definition
create table qw_payment_approval_record
(
    id          bigint auto_increment
        primary key,
    sp_no       varchar(50)                        not null comment '审批号',
    note_code   varchar(50)                        null comment '资金系统返回流水号',
    respcode    varchar(50)                        null comment '响应码 S00001:成功 E00001：失败',
    respmsg     text                               null comment '响应信息',
    resp        text                               null comment '第三方系统返回结果',
    pay_state   varchar(20)                        null comment '支付状态',
    remark      varchar(50)                        null comment '备注',
    create_time datetime default CURRENT_TIMESTAMP not null,
    update_time datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP
)
    comment '企微付款审批记录';


```

![image-20241213155617997](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241213155617997.png)

qw_payment_approval表中的srcbatch_no字段会同步给第三方支付系统可以认为是唯一的订单请求流水号。sp_no是这个企微审批模版的审批号主订单号，sub_no可以认为子订单号。qw_payment_approval_record表的sp_no对应qw_payment_approval表的子订单号。

## 代码

1、接口地址  /qy/event/manual-approval   (wechat项目 QyWechatEventNotifyController)

![image-20241112102418535](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241112102418535.png)

2、消费OA回调 （noa项目，QwApprovalServiceImpl类）

![image-20241112102732416](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241112102732416.png)

![image-20241112103017413](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241112103017413.png)

![image-20241112103249106](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241112103249106.png)



核心逻辑先解析企微审批里面的内容，查看这个方法，解析完后构建请求第三方对象，对象属性查看接口文档

![image-20241112105514017](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241112105514017.png)

![image-20241227150417133](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241227150417133.png)

调用Order项目

![image-20241112110051401](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241112110051401.png)

![image-20241112110345038](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241112110345038.png)

![image-20241112110504300](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241112110504300.png) 



## 添加模板



发送了对应模板之后需要去数据库中添加相对应的数据

![image-20241128104600020](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241128104600020.png) 

![image-20241128105516414](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241128105516414.png) 

将如上信息填写到下面表中

![image-20241128104900619](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241128104900619.png) 

![image-20241128105705525](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241128105705525.png) 



 ![image-20241128110016337](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241128110016337.png)





## 爱盟客同意提现代码逻辑步骤

**老接口**

```
/brokerage/withdraw/qwWithdrawApproval/{id}
```

**新接口**

```
/brokerage/withdraw/qwWithdrawApproval/qwWithdrawDetailApproval
```



请求接口提交审批到企微

![image-20241228154933029](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228154933029.png) 



企微中有配置我们系统的相关回调接口，相关配置信息请到企微应用中查看

![image-20241228152148020](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228152148020.png) 



根据接口找到相关入口代码在项目lspace-wechat

![image-20241228152244851](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228152244851.png)

主要使用的是Pulsar的topic为approval_pay_notify



消费者在lspace-noa消费

![image-20241228152344456](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228152344456.png) 

根据审批名称中的内容获取到对应的策略

![image-20241228153927425](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228153927425.png)

![image-20241228153952775](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228153952775.png)



使用的是付款审批，所以走的是付款的策略对象去调用

![image-20241228155107726](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228155107726.png)

向银企直联第三方发起付款申请

![image-20241228155207904](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228155207904.png)

进到lspace-order的mbsService接口

调用银企直联第三方接口

![image-20241228161609645](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228161609645.png)

如果响应成功，那么会将对应的企微付款审批记录的状态修改为支付中

![image-20241228161648595](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228161648595.png)





这块会去查询 本系统中企微付款审批记录状态为支付中的数据去 银企直联上查看支付状态

![image-20241228162859949](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228162859949.png)

![image-20241228161819946](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228161819946.png)

对相关的状态进行更新

![image-20241228161922032](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228161922032.png)



有定时器会去查询银企直联的回单信息

![image-20241228155832538](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228155832538.png)



lspace-order中有定时器会去更新支付状态，先把【支付中】的数据都查出来，根据对应提现记录的spNo去查已经支付成功了的记录，如果查出来了就给他们改成已支付。

![image-20241228155715018](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20241228155715018.png)



![image-20250104170638867](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20250104170638867.png) ![image-20250104170648532](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20250104170648532.png) 



​	













