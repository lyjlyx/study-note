# 秒杀专题

## 什么是秒杀

短时间（瞬时），大量的请求买一件商品

高并发（读、写）

**瞬时大量的请求，解决瞬时的读和写**



如何让有效的请求来访问我们的商品



### 秒杀的目标

稳：高可用，系统稳定的提供服务。



准：超卖的问题，其实就是数据一致性的问题



快：高性能（优化的点都在这里）



防：防止恶意的请求，才能提高性能，给正常的用户提供正常的服务。





### 架构原则

#### 减少用户和服务端的交互



数据要少：请求参数和响应参数要少，降低对网络带宽的占用，降低对CPU的占用消耗，对IO数据库。（非必要的信息不要来回传）。

请求数要少：把多次的请求合并成一次。

![image-20220707154003453](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20220707154003453.png) 

路径要短：每个节点可靠性

依赖要少：其他依赖的东西尽量要减少。优先级高的展示，优先级低的去掉。

保证高可用，每个节点不要是一个，做好备份：负载均衡、水平扩展，服务不依赖于具体的数据，可以横向扩展。



不要单点：保证高可用：负载均衡，水平扩展



### 动静数据分离

数据区分：url，用户，浏览的时间，地域，cookie(缓存信息) -> 静态数据。CDN，负载均衡放静态数据。

Nginx可以做静态资源服务器。



url1(商品详情)，url1：和详情(json)做映射。

放到离用户最近的地方，CDN（浏览器缓存，服务器缓存guva cache, map,redis 缓存，文件缓存等）



根据不同的用户类型做缓存。

CSI：Client side include

iframe ajax 局部刷新



### 热点数据的处理

本来卖衣服秒杀，但是被卖苹果的把流量抢走了。



#### 识别热点数据

监控，追踪。用户访问，添加购物车，下单，统计分析（经验,BI）

分流（双11，11.1号就开始到11.11）

发现热点数据：分析日志，添加队列，系统订阅。

系统计算某个页面商品访问量大，给他扔到对应的MQ里头，收到该系统访问量突然变大，就给他水平扩容。



#### 处理热点数据

优化：

LRU算法



消息队列像“蓄水池”一样慢慢的处理数据。



限流的话就是，我只能接住10个请求，然后来了11个， 我就把多的那一个扔掉

削峰的话就是，我只能接住10个请求，但是来了100个，我会把你这100个全部接住，然后慢慢的消化



**局部处理**：

锁

queue

序列化

把请求直接序列化到存储上，然后慢慢的把数据消化掉。



分层过滤（验证码的思路、答题）

cdn过滤



答题：

题库的生成

题库的推送

判题的速度更快（k,v）



黑名单：拦截机器人请求，一个机器人只会在一台机器上发送多个请求。



走到服务器后端了，影响性能的点有哪些？

cpu频率，IO（网卡、磁盘IOPS）



RT（Response Time）

程序的时间消耗：

1、程序等待执行的时间（几乎不影响）

2、执行的时间（）





（粗略）线程数=2n+1

（精细）线程数=（（线程等待时间+cpu执行时间）/cpu时间）*cpu核数

**使用实际的性能测试，得结论**



预估业务量：2000qps

预估业务量，10w人



**数据一致性如何保证？**

下单、付款

下单扣库存，可以先做一次预扣（超时回退）。

**这个订单在没有支付完成的时候该怎么做？**

加一个中间状态，支付中。等待第三方回调，如果第三方没有回调，我们就主动去第三方请求



支付流程
在app上面支付，有个第三方的sdk（集成支付宝的sdk或者其他的）



![image-20220707181036067](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20220707181036067.png) 





![image-20220707181703609](https://lyx-study-note-image.oss-cn-shenzhen.aliyuncs.com/img/image-20220707181703609.png)



## 分布式事务

提高高并发：通过牺牲一致性来完成

![image-20220708150219006](D:\TyporaNote\马士兵教育\技术\秒杀\分布式专题.assets\image-20220708150219006.png) 

优势是并发量大，但是数据一致性不强



两阶段提交的场景都会有数据不一致的问题：**单点故障、数据不一致、性能问题**









### 另种方案消息队列加本地事件表

























